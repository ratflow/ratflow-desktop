#!/bin/bash
## $SCRIPT_NAME v$SCRIPT_VERSION
##
## RATFLOW desktop session launcher.
##
## Usage: $SCRIPT_FILENAME [options]
##
## Options:
##   -c, --confirm  Confirm system/account changes.
##   -h, --help    	Display this message.
##   -v, --version 	Display script version.
##

#===========================================


SCRIPT_NAME=ratflow-session
SCRIPT_FILENAME=$(basename "$0")
SCRIPT_VERSION=0.1.1
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

set -e          # exit on command errors (so you MUST handle exit codes properly!)
#set -o pipefail # capture fail exit codes in piped commands
#set -x         # execution tracing debug messages

#exec 3>&1 4>&2
#trap 'exec 2>&4 1>&3' 0 1 2 3
#exec 1>$HOME/.$SCRIPT_NAME.log 2>&1
# Everything below will go to the file 'log.out':

ratconfig="$HOME/.config/ratflow/config"
confirm=0

#===========================================


function usage {
  [ "$*" ] && echo "$0: $*"
  sed -n '/^##/,/^$/s/^## \{0,1\}//p' "$SCRIPT_DIR/$SCRIPT_FILENAME" |
      sed "s/\$SCRIPT_NAME/$SCRIPT_NAME/g" |
      sed "s/\$SCRIPT_FILENAME/$SCRIPT_FILENAME/g" |
      sed "s/\$SCRIPT_VERSION/$SCRIPT_VERSION/g"
      
  exit 2
} 2>/dev/null


function main {
    
    while [ $# -gt 0 ]; do
	case $1 in
	    ('-h'|'--help')
		usage 2>&1;;
	    ('-c'|'--confirm')
		shift
		confirm=1
		break;;
	    ('--')
		shift
		break;;
	    ('-'*)
		echo -e "\n$0 $1: unknown option. Use --help to learn more.\n"
		exit 3
		break;;
	esac
	
	shift
    done
    
    run
}

#===========================================


function run {

	if [ ! -f "$ratconfig" ]
	then
		initUserConfig
	fi

	startWindowManager
}


function initUserConfig {
	safeCp /usr/share/ratflow/configs/config "$ratconfig"
	
	safeCp /usr/share/ratflow/configs/gtkrc-2.0 $HOME/.gtkrc-2.0
	safeCp /usr/share/ratflow/configs/gtk-3.0-settings.ini $HOME/.config/gtk-3.0/settings.ini
	safeCp /usr/share/ratflow/configs/terminator-config $HOME/.config/terminator/config
	safeCp /usr/share/ratflow/configs/dunstrc $HOME/.config/dunst/dunstrc
	safeCp /usr/share/ratflow/configs/ulauncher $HOME/.config/ulauncher
}


function safeCp {
	src="$1"
	dst="$2"
	
	if [ ! -f "$src" ]; then
		echo "ERROR: source file \"$src\" not found"
		exit 1
	fi
	
	mkdir -p $(dirname $dst) 2>/dev/null
	
	confirmCp "$src" "$dst"
}

function confirmCp { 
	src="$1"
	dst="$2"
	
	if [ -f "$dst" ]; then
		
		c="y"
		
		if [ $confirm == 1 ]; then
			echo -e -n "The file \"$dst\" already exists.\nDo you want to backup it and create new one? [y]/n/all: "
			read c
		
			if [ "$c" == "all" ]; then confirm=0; fi
		fi
		
		
		if [ "$c" != "n" ]; then
			backupFile="$dst.backup-"$(date +%Y%m%d%H%M)
			cp -rv "$dst" "$backupFile"
			cp -rvf "$src" "$dst"
		fi
		
	else
		cp -rv "$src" "$dst"
	fi
}

function startWindowManager {
	i3 -c "$ratconfig"
}


#===========================================

main "$@"





